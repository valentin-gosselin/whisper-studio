{% extends "admin/base.html" %}

{% block title %}Dashboard Admin{% endblock %}

{% block extra_css %}
<style>
    /* Stats Grid - structure only */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 30px;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Désactiver hover sur stats cards */
    .stats-grid .stat-card {
        pointer-events: none;
    }

    /* Charts Grid - structure only */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    @media (max-width: 900px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Tables - use job-item styling from theme */
    .dashboard-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .dashboard-table th,
    .dashboard-table td {
        padding: 12px;
        text-align: left;
    }

    .dashboard-table th {
        font-weight: 600;
        font-size: 13px;
    }

    .dashboard-table td {
        font-size: 14px;
    }

    .error-msg {
        font-family: monospace;
        font-size: 11px;
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Section titles */
    h2.section-title {
        margin-top: 30px;
        margin-bottom: 15px;
    }

    h2.section-title:first-of-type {
        margin-top: 0;
    }

    h3.subsection-title {
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 16px;
    }

    /* Simple bar chart */
    .simple-bar-chart {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px 0;
    }

    .bar-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .bar-label {
        width: 60px;
        font-size: 12px;
        color: white;
        flex-shrink: 0;
    }

    body.neon-night .bar-label {
        color: #00ffff;
    }

    .bar-container {
        flex: 1;
        height: 25px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    body.neon-night .bar-container {
        background: rgba(0,255,255,0.1);
    }

    .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
        transition: width 0.3s ease;
        min-width: 30px;
    }

    body.neon-night .bar-fill {
        background: linear-gradient(90deg, rgba(0,255,255,0.6), rgba(0,200,255,0.8));
    }

    .bar-value {
        font-size: 11px;
        font-weight: 600;
        color: white;
    }

    /* Simple list */
    .simple-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px 0;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
    }

    body.neon-night .list-item {
        background: rgba(0,255,255,0.05);
    }

    .list-label {
        font-size: 13px;
        color: white;
    }

    body.neon-night .list-label {
        color: #00ffff;
    }

    .list-value {
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<!-- DEBUG VERSION: 2024-11-27 15:35 - Fix dark mode colors -->
<h2 class="section-title">Vue d'ensemble</h2>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_users }}</div>
        <div class="stat-label">Utilisateurs</div>
        <div class="stat-detail">{{ stats.active_today }} aujourd'hui, {{ stats.active_week }} cette semaine</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">{{ stats.total_jobs }}</div>
        <div class="stat-label">Jobs totaux</div>
        <div class="stat-detail">{{ stats.jobs_today }} aujourd'hui, {{ stats.completed_jobs }} réussis</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">
            {% if stats.total_disk_usage >= 1024 * 1024 * 1024 %}
                {{ (stats.total_disk_usage / 1024 / 1024 / 1024) | round(2) }} Go
            {% elif stats.total_disk_usage >= 1024 * 1024 %}
                {{ (stats.total_disk_usage / 1024 / 1024) | round(2) }} Mo
            {% elif stats.total_disk_usage >= 1024 %}
                {{ (stats.total_disk_usage / 1024) | round(2) }} Ko
            {% else %}
                {{ stats.total_disk_usage }} octets
            {% endif %}
        </div>
        <div class="stat-label">Espace disque</div>
        <div class="stat-detail">{{ stats.total_documents }} documents</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">{{ stats.error_jobs }}</div>
        <div class="stat-label">Erreurs</div>
        <div class="stat-detail">{{ stats.queued_jobs }} en queue, {{ stats.processing_jobs }} en traitement</div>
    </div>
</div>

<h2 class="section-title">Statistiques détaillées</h2>

<div class="charts-grid">
    <!-- Jobs per day -->
    <div class="chart-card">
        <h3>Jobs par jour (7 derniers jours)</h3>
        <div class="simple-bar-chart">
            {% set max_count = stats.jobs_per_day | map(attribute='count') | max %}
            {% for day in stats.jobs_per_day %}
            <div class="bar-item">
                <div class="bar-label">{{ day.date[-5:] }}</div>
                <div class="bar-container">
                    <div class="bar-fill" style="width: {% if max_count > 0 %}{{ (day.count * 100 / max_count) | int }}%{% else %}0%{% endif %}">
                        <span class="bar-value">{{ day.count }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Top languages -->
    <div class="chart-card">
        <h3>Top 5 langues</h3>
        <div class="simple-list">
            {% for lang, count in stats.top_languages[:5] %}
            <div class="list-item">
                <span class="list-label">{{ lang or 'Non défini' }}</span>
                <span class="list-value badge badge-info">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Processing modes -->
    <div class="chart-card">
        <h3>Modes de traitement</h3>
        <div class="simple-list">
            {% for mode, count in stats.processing_modes %}
            <div class="list-item">
                <span class="list-label">{{ mode }}</span>
                <span class="list-value badge badge-info">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Document types -->
    <div class="chart-card">
        <h3>Types de documents</h3>
        <div class="simple-list">
            {% for doc_type, count in stats.doc_types %}
            <div class="list-item">
                <span class="list-label">{{ doc_type }}</span>
                <span class="list-value badge badge-info">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Average processing times -->
{% if stats.avg_times %}
<h2 class="section-title">Temps de traitement moyens</h2>
<div class="job-item" style="padding: 0;">
    <table class="dashboard-table">
        <thead>
            <tr>
                <th>Mode</th>
                <th>Temps moyen</th>
            </tr>
        </thead>
        <tbody>
            {% for mode, avg_seconds in stats.avg_times %}
            <tr>
                <td><span class="badge badge-info">{{ mode }}</span></td>
                <td>{{ (avg_seconds / 60) | round(1) }} minutes ({{ avg_seconds | round(0) | int }} secondes)</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Top errors -->
{% if stats.top_errors %}
<h2 class="section-title">Top 10 erreurs fréquentes</h2>
<div class="job-item" style="padding: 0;">
    <table class="dashboard-table">
        <thead>
            <tr>
                <th>Message d'erreur</th>
                <th>Occurrences</th>
            </tr>
        </thead>
        <tbody>
            {% for error_msg, count in stats.top_errors %}
            <tr>
                <td class="error-msg" title="{{ error_msg }}">{{ error_msg }}</td>
                <td><span class="badge badge-danger">{{ count }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<h2 class="section-title">Activité récente</h2>

<!-- Recent users -->
<h3 class="subsection-title">Utilisateurs récents</h3>
<div class="job-item" style="padding: 0;">
    <table class="dashboard-table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Rôle</th>
                <th>Statut</th>
                <th>Inscrit le</th>
            </tr>
        </thead>
        <tbody>
            {% for user in stats.recent_users %}
            <tr>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.role == 'admin' %}
                        <span class="badge badge-admin">Admin</span>
                    {% else %}
                        <span class="badge badge-user">User</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                        <span class="badge badge-active">Actif</span>
                    {% else %}
                        <span class="badge badge-inactive">Inactif</span>
                    {% endif %}
                </td>
                <td>{{ user.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Recent jobs -->
<h3 class="subsection-title">Jobs récents</h3>
<div class="job-item" style="padding: 0;">
    <table class="dashboard-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Mode</th>
                <th>Type</th>
                <th>Statut</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for job in stats.recent_jobs %}
            <tr>
                <td>{{ job.id }}</td>
                <td>
                    {% if job.processing_mode == 'smart_doc' %}
                        <span class="badge badge-smart_doc">{{ job.processing_mode }}</span>
                    {% elif job.processing_mode == 'srt' or job.mode == 'srt' %}
                        <span class="badge badge-srt">{{ job.processing_mode or job.mode }}</span>
                    {% else %}
                        <span class="badge badge-document">{{ job.processing_mode or job.mode }}</span>
                    {% endif %}
                </td>
                <td>{{ job.doc_type or 'N/A' }}</td>
                <td>
                    {% if job.status == 'completed' %}
                        <span class="job-status status-completed">Complété</span>
                    {% elif job.status == 'error' %}
                        <span class="job-status status-error">Erreur</span>
                    {% elif job.status == 'processing' %}
                        <span class="job-status status-processing">En cours</span>
                    {% elif job.status == 'queued' %}
                        <span class="job-status status-pending">En queue</span>
                    {% else %}
                        <span class="job-status">{{ job.status }}</span>
                    {% endif %}
                </td>
                <td>{{ job.created_at.strftime('%d/%m/%Y %H:%M') if job.created_at else 'N/A' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- System Metrics -->
<h2 class="section-title" style="margin-top: 30px;">Métriques Système</h2>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">CPU</div>
        <div class="stat-value" id="cpu-usage">--%</div>
        <div class="stat-detail" id="cpu-cores">-- coeurs</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">RAM</div>
        <div class="stat-value" id="ram-usage">--%</div>
        <div class="stat-detail" id="ram-details">-- / -- GB</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Disque</div>
        <div class="stat-value" id="disk-usage">--%</div>
        <div class="stat-detail" id="disk-details">-- / -- GB</div>
    </div>
</div>

<script>
// Fetch system metrics
async function fetchMetrics() {
    try {
        const response = await fetch('/admin/metrics');
        const metrics = await response.json();

        if (metrics.error) {
            console.error('Metrics error:', metrics.error);
            return;
        }

        // Update CPU
        document.getElementById('cpu-usage').textContent = metrics.cpu.percent + '%';
        document.getElementById('cpu-cores').textContent = metrics.cpu.count + ' coeurs';

        // Update RAM
        document.getElementById('ram-usage').textContent = metrics.ram.percent + '%';
        document.getElementById('ram-details').textContent =
            metrics.ram.used_gb + ' / ' + metrics.ram.total_gb + ' GB';

        // Update Disk
        document.getElementById('disk-usage').textContent = metrics.disk.percent + '%';
        document.getElementById('disk-details').textContent =
            metrics.disk.used_gb + ' / ' + metrics.disk.total_gb + ' GB';

    } catch (error) {
        console.error('Failed to fetch metrics:', error);
    }
}

// Fetch metrics on page load
fetchMetrics();

// Refresh metrics every 5 seconds
setInterval(fetchMetrics, 5000);
</script>
{% endblock %}

