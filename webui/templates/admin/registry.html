{% extends "admin/base.html" %}
{% block title %}Registre des traitements{% endblock %}

{% block extra_css %}
<style>
    .legal-content {
        line-height: 1.8;
        font-size: 15px;
    }

    .legal-content h2 {
        font-size: 22px;
        font-weight: 700;
        margin-top: 35px;
        margin-bottom: 18px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .legal-content h2:first-child {
        margin-top: 0;
    }

    body.neon-night .legal-content h2 {
        border-bottom-color: rgba(0, 255, 255, 0.2);
    }

    .legal-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 25px;
        margin-bottom: 14px;
        opacity: 0.95;
    }

    .legal-content h4 {
        font-size: 13px;
        font-weight: 700;
        margin-top: 18px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        opacity: 0.7;
    }

    .legal-content p {
        margin-bottom: 14px;
        opacity: 0.9;
    }

    .legal-content ul {
        margin: 15px 0 20px 30px;
        list-style-type: none;
        padding-left: 0;
    }

    .legal-content li {
        margin-bottom: 8px;
        padding-left: 25px;
        line-height: 1.7;
        position: relative;
        color: rgba(255, 255, 255, 0.9);
    }

    .legal-content li::before {
        content: '•';
        position: absolute;
        left: 8px;
        font-size: 20px;
        line-height: 1.5;
        color: rgba(255, 255, 255, 0.7);
    }

    body.neon-night .legal-content li {
        color: rgba(0, 255, 255, 0.9);
    }

    body.neon-night .legal-content li::before {
        color: rgba(0, 255, 255, 0.7);
        text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
    }

    .legal-content strong {
        font-weight: 700;
        opacity: 1;
    }

    .registry-intro {
        padding: 20px 30px;
        margin-bottom: 30px;
        border-left: 4px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    body.neon-night .registry-intro {
        border-left-color: rgba(0, 255, 255, 0.4);
        background: rgba(0, 255, 255, 0.03);
    }

    .export-section {
        text-align: right;
        margin-bottom: 30px;
    }

    .section-divider {
        margin: 50px 0 40px 0;
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
    }

    body.neon-night .section-divider {
        border-bottom-color: rgba(0, 255, 255, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="legal-content">
    <h2>Registre des traitements (RGPD Art. 30)</h2>

    <div class="export-section">
        <a href="/admin/registry/export-pdf" class="btn" style="text-decoration: none; width: auto; display: inline-block;">Exporter en PDF</a>
    </div>

    <div class="registry-intro">
        <p style="margin: 0;">Ce registre documente tous les traitements de données personnelles effectués par Whisper Studio, conformément à l'article 30 du RGPD. Il doit être tenu à jour et disponible pour les autorités de contrôle sur demande.</p>
    </div>

    <!-- Traitement 1 -->
    <h3>1. Gestion des comptes utilisateurs <span class="badge">Essentiel</span></h3>

    <h4>Finalité du traitement</h4>
    <p>Authentification, gestion des accès à la plateforme et administration des comptes utilisateurs</p>

    <h4>Catégories de données collectées</h4>
    <ul>
        <li><strong>Données d'identification :</strong> Adresse email, nom d'utilisateur</li>
        <li><strong>Données de connexion :</strong> Mot de passe hashé (bcrypt), date de création du compte, date de dernière connexion</li>
        <li><strong>Données techniques :</strong> Rôle utilisateur (admin/user), statut actif/inactif, préférences (thème, notifications)</li>
    </ul>

    <h4>Personnes concernées</h4>
    <p>Tous les utilisateurs enregistrés de la plateforme (administrateurs et utilisateurs)</p>

    <h4>Destinataires des données</h4>
    <ul>
        <li>Responsable de traitement uniquement (pas de partage avec des tiers)</li>
        <li>Hébergement sur serveur propre (pas de cloud tiers)</li>
    </ul>

    <h4>Durée de conservation</h4>
    <ul>
        <li><strong>Comptes actifs :</strong> Durée d'utilisation du service</li>
        <li><strong>Comptes inactifs :</strong> Suppression automatique après 1 an d'inactivité (notification 30 jours avant)</li>
        <li><strong>Comptes supprimés :</strong> Suppression immédiate et définitive</li>
    </ul>

    <h4>Base légale</h4>
    <p><span class="badge badge-active">Exécution du contrat (Art. 6.1.b RGPD)</span></p>

    <h4>Mesures de sécurité</h4>
    <ul>
        <li>Hashage sécurisé des mots de passe (bcrypt)</li>
        <li>Sessions Flask sécurisées (Flask-Session)</li>
        <li>Authentification obligatoire pour accès aux fonctionnalités</li>
        <li>Isolation des données par utilisateur</li>
    </ul>

    <div class="section-divider"></div>

    <!-- Traitement 2 -->
    <h3>2. Transcription audio et vidéo <span class="badge">Service principal</span></h3>

    <h4>Finalité du traitement</h4>
    <p>Traitement des fichiers audio/vidéo pour génération de transcriptions textuelles via intelligence artificielle (Whisper)</p>

    <h4>Catégories de données collectées</h4>
    <ul>
        <li><strong>Fichiers source :</strong> Fichiers audio/vidéo uploadés temporairement</li>
        <li><strong>Métadonnées :</strong> Nom du fichier, taille, durée, format, date d'upload</li>
        <li><strong>Contenu vocal :</strong> Paroles transcrites, horodatage, identification des locuteurs (si activé)</li>
    </ul>

    <h4>Personnes concernées</h4>
    <p>Utilisateurs uploadant des fichiers + personnes dont la voix apparaît dans les enregistrements</p>

    <h4>Destinataires des données</h4>
    <ul>
        <li>Serveur de transcription Whisper (en local, pas de cloud)</li>
        <li>Serveur de diarisation Pyannote (en local, si activé)</li>
        <li>Aucun partage avec des services tiers externes</li>
    </ul>

    <h4>Durée de conservation</h4>
    <ul>
        <li><strong>Fichiers uploadés :</strong> Supprimés automatiquement après traitement (conservation temporaire uniquement)</li>
        <li><strong>Transcriptions générées :</strong> Conservées tant que l'utilisateur conserve son compte</li>
        <li><strong>Suppression manuelle :</strong> Possible à tout moment par l'utilisateur</li>
    </ul>

    <h4>Base légale</h4>
    <p><span class="badge badge-active">Exécution du contrat (Art. 6.1.b RGPD)</span></p>

    <h4>Mesures de sécurité</h4>
    <ul>
        <li>Dossiers isolés par utilisateur (hash de l'email)</li>
        <li>Vérification stricte de propriété des fichiers</li>
        <li>Prévention de path traversal</li>
        <li>Traitement local (pas de cloud externe)</li>
        <li>Suppression automatique des fichiers temporaires</li>
    </ul>

    <div class="section-divider"></div>

    <!-- Traitement 3 -->
    <h3>3. Génération de documents intelligents <span class="badge">Service principal</span></h3>

    <h4>Finalité du traitement</h4>
    <p>Génération de documents formatés (TXT, DOCX, SRT) à partir des transcriptions, avec enrichissement optionnel via IA (Ollama)</p>

    <h4>Catégories de données collectées</h4>
    <ul>
        <li><strong>Documents générés :</strong> Fichiers TXT, DOCX, SRT avec transcriptions formatées</li>
        <li><strong>Métadonnées :</strong> Titre, date de création, taille, mode de génération</li>
        <li><strong>Paramètres de traitement :</strong> Options IA (résumé, mise en forme), speakers</li>
        <li><strong>Historique :</strong> Jobs de transcription (statut, durée, erreurs)</li>
    </ul>

    <h4>Personnes concernées</h4>
    <p>Utilisateurs générant des documents</p>

    <h4>Destinataires des données</h4>
    <ul>
        <li>Serveur Ollama (LLM local) pour enrichissement des documents (si activé)</li>
        <li>Aucun partage avec des services tiers</li>
    </ul>

    <h4>Durée de conservation</h4>
    <ul>
        <li><strong>Documents :</strong> Conservés tant que l'utilisateur conserve son compte</li>
        <li><strong>Historique de jobs :</strong> Conservé avec les métadonnées des documents</li>
        <li><strong>Suppression :</strong> Suppression manuelle possible à tout moment</li>
    </ul>

    <h4>Base légale</h4>
    <p><span class="badge badge-active">Exécution du contrat (Art. 6.1.b RGPD)</span></p>

    <h4>Mesures de sécurité</h4>
    <ul>
        <li>Isolation des documents par utilisateur</li>
        <li>Contrôle d'accès strict (propriétaire uniquement)</li>
        <li>Traitement IA en local (pas de cloud externe)</li>
        <li>Cascade de suppression (suppression compte → suppression documents)</li>
    </ul>

    <div class="section-divider"></div>

    <!-- Traitement 4 -->
    <h3>4. Système d'invitations utilisateurs <span class="badge">Administration</span></h3>

    <h4>Finalité du traitement</h4>
    <p>Gestion des accès à la plateforme via système d'invitations par email (administrateurs uniquement)</p>

    <h4>Catégories de données collectées</h4>
    <ul>
        <li><strong>Email invité :</strong> Adresse email du futur utilisateur</li>
        <li><strong>Token d'invitation :</strong> Token sécurisé unique</li>
        <li><strong>Métadonnées :</strong> Date de création, date d'expiration (7 jours), statut (pending/accepted)</li>
    </ul>

    <h4>Personnes concernées</h4>
    <p>Personnes invitées à rejoindre la plateforme par un administrateur</p>

    <h4>Destinataires des données</h4>
    <ul>
        <li>Serveur SMTP pour envoi de l'email d'invitation</li>
        <li>Administrateurs de la plateforme (visualisation des invitations)</li>
    </ul>

    <h4>Durée de conservation</h4>
    <ul>
        <li><strong>Invitations pending :</strong> Supprimées automatiquement après 7 jours d'expiration</li>
        <li><strong>Invitations acceptées :</strong> Supprimées dès la création du compte</li>
    </ul>

    <h4>Base légale</h4>
    <p><span class="badge badge-active">Intérêt légitime (Art. 6.1.f RGPD)</span> - Gestion des accès sécurisés</p>

    <h4>Mesures de sécurité</h4>
    <ul>
        <li>Tokens sécurisés (secrets.token_urlsafe)</li>
        <li>Expiration automatique après 7 jours</li>
        <li>Limitation aux administrateurs uniquement</li>
        <li>Email non réutilisable après acceptation</li>
    </ul>

    <div class="section-divider"></div>

    <!-- Traitement 5 -->
    <h3>5. Notifications et communications par email <span class="badge">Communication</span></h3>

    <h4>Finalité du traitement</h4>
    <p>Envoi de notifications liées au service (invitations, alertes de suppression de compte, notifications de transcription terminée si activées)</p>

    <h4>Catégories de données collectées</h4>
    <ul>
        <li><strong>Adresse email :</strong> Email de l'utilisateur</li>
        <li><strong>Contenu des notifications :</strong> Informations sur l'action concernée</li>
        <li><strong>Historique d'envoi :</strong> Date de notification de suppression (deletion_notified_at)</li>
    </ul>

    <h4>Personnes concernées</h4>
    <p>Tous les utilisateurs recevant des notifications</p>

    <h4>Destinataires des données</h4>
    <ul>
        <li>Serveur SMTP configuré (mail.gosselin.pro)</li>
        <li>Utilisateur destinataire uniquement</li>
    </ul>

    <h4>Durée de conservation</h4>
    <ul>
        <li><strong>Date de notification :</strong> Conservée jusqu'à action (connexion ou suppression)</li>
        <li><strong>Emails envoyés :</strong> Non conservés (transmis uniquement)</li>
    </ul>

    <h4>Base légale</h4>
    <p>
        <span class="badge badge-active">Exécution du contrat (Art. 6.1.b RGPD)</span> pour notifications de service<br>
        <span class="badge badge-active">Obligation légale (Art. 6.1.c RGPD)</span> pour notifications RGPD (suppression compte)
    </p>

    <h4>Mesures de sécurité</h4>
    <ul>
        <li>Connexion SMTP sécurisée (TLS)</li>
        <li>Pas de stockage des emails envoyés</li>
        <li>Respect de la préférence utilisateur (notifications désactivables pour transcriptions)</li>
    </ul>

    <div class="section-divider"></div>

    <!-- Footer -->
    <div class="registry-intro" style="margin-top: 40px;">
        <p><strong>Droits des personnes concernées :</strong> Conformément aux articles 15 à 22 du RGPD, toute personne peut exercer ses droits d'accès, de rectification, d'effacement, de limitation, de portabilité et d'opposition via la page Profil > Données ou en contactant le responsable de traitement.</p>
    </div>

    <div class="registry-intro">
        <p><strong>Transferts de données hors UE :</strong> Aucun. Toutes les données sont traitées et hébergées localement sur le serveur de production, sans recours à des services cloud tiers.</p>
    </div>

    <div class="registry-intro">
        <p><strong>Dernière mise à jour :</strong> {{ current_date }}</p>
    </div>
</div>
{% endblock %}
