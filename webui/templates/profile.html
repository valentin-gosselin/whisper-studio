{% extends "base_auth.html" %}

{% block title %}Mon Profil - Whisper Studio{% endblock %}
{% block subtitle %}Gérez votre compte{% endblock %}

{% block extra_styles %}
<style>
    /* Profile-specific styles - Everything else is in centralized CSS */
    .auth-container {
        max-width: 600px;
    }

    /* Tabs */
    .profile-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        padding-bottom: 10px;
    }

    .profile-tab {
        padding: 12px 24px;
        background: rgba(255,255,255,0.1);
        border: none;
        border-radius: 8px 8px 0 0;
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .profile-tab:hover {
        background: rgba(255,255,255,0.15);
    }

    .profile-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    body.neon-night .profile-tabs {
        border-bottom-color: rgba(0,255,255,0.2);
    }

    body.neon-night .profile-tab {
        background: rgba(0,255,255,0.1);
        color: #00ffff;
    }

    body.neon-night .profile-tab:hover {
        background: rgba(0,255,255,0.15);
    }

    body.neon-night .profile-tab.active {
        background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
        color: #0a0a1a;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Toast animations */
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block navigation %}
<div class="top-navigation">
    <a href="{{ url_for('index') }}" class="nav-link">← Retour à l'app</a>
    <div style="display: flex; gap: 15px; align-items: center;">
        <a href="{{ url_for('library.library') }}" class="nav-link">Bibliothèque</a>
        {% if current_user.is_admin %}
        <a href="/admin" class="nav-link">Administration</a>
        {% endif %}
    </div>
</div>

<!-- Modales (en dehors du glass-container pour éviter le blur) -->
<!-- Modal Export Data -->
<div id="exportDataModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="modal-close" onclick="closeExportDataModal()">&times;</span>
        <h2 style="margin-top: 0;">Export de vos données</h2>
        <p class="help-text" style="margin: 15px 0;">
            Pour confirmer l'export de vos données, veuillez saisir votre mot de passe.
        </p>

        <div class="form-group" style="margin: 20px 0;">
            <label for="export_password">Mot de passe</label>
            <input type="password" id="export_password" class="form-control" required
                   placeholder="Votre mot de passe actuel">
        </div>

        <div style="background: rgba(52, 152, 219, 0.15); border-left: 3px solid #3498db; padding: 12px; border-radius: 6px; margin: 15px 0;">
            <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                Un fichier ZIP sera téléchargé contenant :<br>
                • Vos informations de compte<br>
                • Tous vos documents<br>
                • L'historique de vos transcriptions
            </p>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeExportDataModal()">Annuler</button>
            <button type="button" class="btn" onclick="confirmExportData()">Télécharger</button>
        </div>
    </div>
</div>

<!-- Modal Delete Account -->
<div id="deleteAccountModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="modal-close" onclick="closeDeleteAccountModal()">&times;</span>
        <h2 style="margin-top: 0; color: #ef4444;">Supprimer mon compte</h2>
        <p class="help-text" style="margin: 15px 0;">
            Cette action est <strong>irréversible</strong>. Tous vos documents et données seront définitivement supprimés.
        </p>

        <div class="form-group" style="margin: 20px 0;">
            <label for="delete_confirm_text">Tapez "SUPPRIMER" pour confirmer</label>
            <input type="text" id="delete_confirm_text" class="form-control" required
                   placeholder="SUPPRIMER" style="text-transform: uppercase;">
        </div>

        <div class="form-group" style="margin: 20px 0;">
            <label for="delete_password">Mot de passe</label>
            <input type="password" id="delete_password" class="form-control" required
                   placeholder="Votre mot de passe actuel">
        </div>

        <div style="background: rgba(239, 68, 68, 0.15); border-left: 3px solid #ef4444; padding: 12px; border-radius: 6px; margin: 15px 0;">
            <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                <strong>Seront supprimés :</strong><br>
                • Votre compte utilisateur<br>
                • Tous vos documents<br>
                • Votre historique de transcriptions<br>
                • Toutes vos données personnelles
            </p>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteAccountModal()">Annuler</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">Supprimer définitivement</button>
        </div>
    </div>
</div>

<!-- Modale de confirmation désactivation 2FA -->
<div id="disable2faModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <span class="modal-close" onclick="closeDisable2FAModal()">&times;</span>
        <h2 style="margin-top: 0;">Désactiver le 2FA ?</h2>
        <p class="help-text" style="margin: 20px 0;">
            Êtes-vous sûr de vouloir désactiver l'authentification à deux facteurs ?
            Cela réduira la sécurité de votre compte.
        </p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDisable2FAModal()">Annuler</button>
            <button type="button" class="btn btn-danger" onclick="confirmDisable2FA()">Désactiver</button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Tabs Navigation -->
<div class="profile-tabs">
    <button class="profile-tab active" onclick="switchProfileTab('general')">Général</button>
    <button class="profile-tab" onclick="switchProfileTab('security')">Sécurité</button>
    <button class="profile-tab" onclick="switchProfileTab('data')">Données</button>
</div>

<!-- Tab 1: General -->
<div id="tab-general" class="tab-content active">
    <!-- User Info Section -->
    <div class="section">
        <h2>Informations du compte</h2>
    <div class="info-row">
        <span class="info-label">Email</span>
        <span class="info-value">{{ current_user.email }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Nom d'utilisateur</span>
        <span class="info-value">{{ current_user.username or 'Non défini' }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Rôle</span>
        <span class="badge {% if current_user.is_admin %}badge-admin{% else %}badge-user{% endif %}">
            {% if current_user.is_admin %}Administrateur{% else %}Utilisateur{% endif %}
        </span>
    </div>
    <div class="info-row">
        <span class="info-label">Membre depuis</span>
        <span class="info-value">{{ current_user.created_at.strftime('%d/%m/%Y') }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Documents créés</span>
        <span class="info-value">{{ doc_count }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Espace de stockage</span>
        <span class="info-value">{{ "%.2f"|format(total_storage / 1024 / 1024) }} Mo / {{ "%.2f"|format(current_user.storage_limit_bytes / 1024 / 1024 / 1024) }} Go</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ storage_percent }}%">
            {{ "%.1f"|format(storage_percent) }}%
        </div>
    </div>
</div>

<!-- Notifications Section -->
<div class="section">
    <h2>Préférences de notification</h2>
    <form method="POST" action="{{ url_for('profile') }}">
        <input type="hidden" name="action" value="update_notifications">

        <div class="checkbox-group">
            <input type="checkbox"
                   id="email_notifications"
                   name="email_notifications"
                   {% if current_user.email_notifications %}checked{% endif %}>
            <label for="email_notifications">Recevoir des emails de notification</label>
        </div>

        <div class="checkbox-group">
            <input type="checkbox"
                   id="inapp_notifications"
                   name="inapp_notifications"
                   {% if current_user.inapp_notifications %}checked{% endif %}>
            <label for="inapp_notifications">Afficher les notifications dans l'application</label>
        </div>

        <button type="submit" class="btn">Sauvegarder les préférences</button>
    </form>
</div>

<!-- Theme Section -->
<div class="section">
    <h2>Apparence</h2>
    <div class="info-row">
        <span class="info-label">Thème de l'interface</span>
        <label class="theme-toggle">
            <span class="toggle-label">Clair</span>
            <input type="checkbox" id="themeToggle">
            <span class="toggle-slider"></span>
            <span class="toggle-label">Sombre</span>
        </label>
    </div>
    <p class="help-text" style="margin-top: 10px;">
        Votre choix sera sauvegardé automatiquement et appliqué à toute l'application.
    </p>
</div>

<!-- Edit Username Section -->
<div class="section">
    <h2>Modifier le nom d'utilisateur</h2>
    <form method="POST" action="{{ url_for('profile') }}">
        <input type="hidden" name="action" value="update_username">

        <div class="form-group">
            <label for="username">Nom d'utilisateur</label>
            <input type="text"
                   id="username"
                   name="username"
                   pattern="[a-zA-Z0-9_-]{3,30}"
                   maxlength="30"
                   value="{{ current_user.username or '' }}"
                   placeholder="Choisissez un nom d'utilisateur">
            <p class="help-text">3-30 caractères : lettres, chiffres, tirets et underscores uniquement. Laissez vide pour utiliser votre email.</p>
        </div>

        <button type="submit" class="btn">Mettre à jour</button>
    </form>
</div>
</div>

<!-- Tab 2: Security -->
<div id="tab-security" class="tab-content">
    <!-- 2FA Section -->
    <div class="section">
        <h2>Authentification à deux facteurs (2FA)</h2>
    <div class="info-row">
        <span class="info-label">Statut 2FA</span>
        {% if current_user.is_2fa_enabled %}
            <span class="badge badge-active">Activé</span>
        {% else %}
            <span class="badge badge-inactive">Désactivé</span>
        {% endif %}
    </div>

    {% if current_user.is_2fa_enabled %}
        <div class="info-row" style="margin-top: 15px;">
            <span class="info-label">Méthode active</span>
            <span class="info-value">
                {% if current_user.twofa_method == 'email' %}
                    Email ({{ current_user.email }})
                {% elif current_user.twofa_method == 'totp' %}
                    Application d'authentification
                {% else %}
                    Application d'authentification (ancienne configuration)
                {% endif %}
            </span>
        </div>

        <p class="help-text" style="margin: 15px 0;">
            Vous pouvez changer de méthode de vérification ou désactiver complètement le 2FA.
        </p>

        <!-- Change Method Form -->
        <form method="GET" action="{{ url_for('change_2fa_method') }}" style="margin-bottom: 20px;">
            <div class="form-group">
                <label for="new_method">Changer de méthode de vérification</label>
                <select name="new_method" id="new_method" required>
                    <option value="">-- Sélectionnez une nouvelle méthode --</option>
                    {% if current_user.twofa_method != 'email' %}
                    <option value="email">Email - Recevoir un code par email</option>
                    {% endif %}
                    {% if current_user.twofa_method != 'totp' %}
                    <option value="totp">Application d'authentification (Google Authenticator, Authy, etc.)</option>
                    {% endif %}
                </select>
                <p class="help-text">Vous devrez vérifier la nouvelle méthode pour confirmer le changement.</p>
            </div>
            <button type="submit" class="btn btn-purple">Modifier la méthode 2FA</button>
        </form>

        <!-- Recovery Codes -->
        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('view_recovery_codes') }}" class="btn btn-orange" style="display: inline-block; text-decoration: none;">
                Voir/Régénérer les codes de récupération
            </a>
            <p class="help-text" style="margin-top: 10px;">
                Les codes de récupération vous permettent de vous connecter si vous perdez l'accès à votre méthode 2FA.
            </p>
        </div>

        <!-- Disable 2FA Form -->
        <form method="POST" action="{{ url_for('disable_2fa') }}" id="disable2faForm">
            <div class="form-group">
                <label for="disable_2fa_password">Mot de passe actuel (requis pour désactiver le 2FA)</label>
                <input type="password" id="disable_2fa_password" name="password" required>
            </div>
            <button type="button" class="btn btn-danger" onclick="showDisable2FAModal()">Désactiver le 2FA</button>
        </form>
    {% else %}
        <p class="help-text" style="margin: 15px 0;">
            L'authentification à deux facteurs ajoute une couche de sécurité supplémentaire à votre compte.
        </p>

        <form method="GET" action="{{ url_for('setup_2fa') }}">
            <div class="form-group">
                <label for="twofa_method">Choisissez votre méthode de vérification</label>
                <select name="method" id="twofa_method" required>
                    <option value="">-- Sélectionnez une méthode --</option>
                    <option value="email">Email - Recevoir un code par email</option>
                    <option value="totp">Application d'authentification (Google Authenticator, Authy, etc.)</option>
                </select>
                <p class="help-text">L'option par email est plus simple mais l'application est plus sécurisée.</p>
            </div>
            <button type="submit" class="btn">Activer le 2FA</button>
        </form>
    {% endif %}
</div>

<!-- Change Password Section -->
<div class="section">
    <h2>Changer le mot de passe</h2>
    <form method="POST" action="{{ url_for('profile') }}">
        <input type="hidden" name="action" value="change_password">

        <div class="form-group">
            <label for="current_password">Mot de passe actuel</label>
            <input type="password" id="current_password" name="current_password" required>
        </div>

        <div class="form-group">
            <label for="new_password">Nouveau mot de passe</label>
            <input type="password" id="new_password" name="new_password" required minlength="8">
        </div>

        <div class="form-group">
            <label for="confirm_password">Confirmer le nouveau mot de passe</label>
            <input type="password" id="confirm_password" name="confirm_password" required minlength="8">
        </div>

        <button type="submit" class="btn">Modifier le mot de passe</button>
    </form>
</div>
</div>

<!-- Tab 3: Data RGPD -->
<div id="tab-data" class="tab-content">
    <!-- Export Data Section (RGPD Article 20) -->
    <div class="section">
        <h2>Export de mes données</h2>
    <p class="help-text" style="margin: 15px 0;">
        Conformément au RGPD (Article 20 - Droit à la portabilité des données), vous pouvez télécharger
        l'intégralité de vos données personnelles dans un format structuré et couramment utilisé.
    </p>

    <div class="info-row" style="margin: 15px 0;">
        <span class="info-label">Données incluses :</span>
        <ul style="margin: 5px 0 0 20px; color: rgba(255,255,255,0.9); line-height: 1.8;">
            <li>Informations du compte (email, username, paramètres)</li>
            <li>Tous vos documents (DOCX, SRT, TXT)</li>
            <li>Métadonnées des documents (titres, tags, dates)</li>
            <li>Historique complet des transcriptions</li>
        </ul>
    </div>

    <button type="button" class="btn" onclick="showExportDataModal()" style="margin-top: 15px;">
        Télécharger mes données (ZIP)
    </button>
</div>

<!-- Delete Account Section (RGPD Article 17) -->
<div class="section">
    <h2>Suppression du compte</h2>
    <p class="help-text" style="margin: 15px 0;">
        Conformément au RGPD (Article 17 - Droit à l'effacement), vous pouvez demander la suppression
        définitive de votre compte et de toutes vos données associées.
    </p>

    <div class="info-row" style="margin: 15px 0; color: rgba(239, 68, 68, 0.9);">
        <span class="info-label" style="color: rgba(239, 68, 68, 1);">Attention :</span>
        <ul style="margin: 5px 0 0 20px; line-height: 1.8;">
            <li>Cette action est <strong>irréversible</strong></li>
            <li>Tous vos documents seront définitivement supprimés</li>
            <li>Votre historique de transcriptions sera effacé</li>
            <li>Vous serez immédiatement déconnecté</li>
        </ul>
    </div>

    <button type="button" class="btn btn-danger" onclick="showDeleteAccountModal()" style="margin-top: 15px; background: #ef4444;">
        Supprimer mon compte
    </button>
</div>
</div>

<script>
    // Toast notification system
    function showNotification(message, type = 'info') {
        const isDark = document.body.classList.contains('neon-night');
        const toast = document.createElement('div');

        const bgColor = isDark ? 'rgba(10, 10, 26, 0.95)' : 'white';
        const textColor = isDark ? '#00ffff' : '#333';
        const borderColor = type === 'success' ? (isDark ? '#00ffff' : '#27ae60') :
                           type === 'error' ? '#e74c3c' :
                           (isDark ? '#00ffff' : '#3498db');

        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            color: ${textColor};
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid ${borderColor};
            ${isDark ? 'box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);' : ''}
        `;

        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">${type === 'success' ? '✓' : type === 'error' ? '✗' : 'i'}</span>
                <span style="flex: 1;">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: ${isDark ? '#00ffff' : '#999'};">×</button>
            </div>
        `;

        document.body.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Tab switching
    function switchProfileTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(`tab-${tabName}`).classList.add('active');
        event.target.classList.add('active');

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');

    // Get current theme from localStorage (already loaded by base_auth.html)
    let currentTheme = localStorage.getItem('theme') || 'light';

    // Set checkbox state based on current theme
    if (currentTheme === 'dark') {
        themeToggle.checked = true;
    }

    // Toggle theme on change with smooth transition effect
    themeToggle.addEventListener('change', () => {
        // Create overlay for smooth transition
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;

        if (themeToggle.checked) {
            // Dark theme transition effect
            overlay.style.background = 'radial-gradient(circle at center, rgba(0, 255, 255, 0.15), transparent)';
            document.body.appendChild(overlay);

            // Trigger animation
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                document.body.classList.add('neon-night');
                localStorage.setItem('theme', 'dark');

                // Fade out overlay
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            }, 300);
        } else {
            // Light theme transition effect
            overlay.style.background = 'radial-gradient(circle at center, rgba(255, 255, 255, 0.3), transparent)';
            document.body.appendChild(overlay);

            // Trigger animation
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                document.body.classList.remove('neon-night');
                localStorage.setItem('theme', 'light');

                // Fade out overlay
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            }, 300);
        }
    });

    // 2FA disable modal functions
    function showDisable2FAModal() {
        const password = document.getElementById('disable_2fa_password').value;
        if (!password) {
            showNotification('Veuillez saisir votre mot de passe avant de désactiver le 2FA', 'error');
            return;
        }
        const modal = document.getElementById('disable2faModal');
        modal.classList.add('active');
    }

    function closeDisable2FAModal() {
        const modal = document.getElementById('disable2faModal');
        modal.classList.remove('active');
    }

    function confirmDisable2FA() {
        document.getElementById('disable2faForm').submit();
    }

    // Close modal on click outside
    document.getElementById('disable2faModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDisable2FAModal();
        }
    });

    // Export Data Modal Functions
    function showExportDataModal() {
        const modal = document.getElementById('exportDataModal');
        modal.classList.add('active');
    }

    function closeExportDataModal() {
        const modal = document.getElementById('exportDataModal');
        modal.classList.remove('active');
        document.getElementById('export_password').value = '';
    }

    async function confirmExportData() {
        const password = document.getElementById('export_password').value;

        if (!password) {
            showNotification('Veuillez saisir votre mot de passe', 'error');
            return;
        }

        const btn = document.querySelector('#exportDataModal .btn:not(.btn-secondary)');
        btn.disabled = true;
        btn.textContent = 'Préparation de l\'export...';

        try {
            const response = await fetch('/api/user/export-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password })
            });

            if (response.ok) {
                // Download the ZIP file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `whisper_studio_export_${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                closeExportDataModal();
                showNotification('Export réussi ! Téléchargement en cours...', 'success');
            } else {
                const data = await response.json();
                showNotification('Erreur : ' + (data.error || 'Échec de l\'export'), 'error');
            }
        } catch (error) {
            console.error('Export error:', error);
            showNotification('Erreur réseau lors de l\'export', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Télécharger';
        }
    }

    // Delete Account Modal Functions
    function showDeleteAccountModal() {
        const modal = document.getElementById('deleteAccountModal');
        modal.classList.add('active');
    }

    function closeDeleteAccountModal() {
        const modal = document.getElementById('deleteAccountModal');
        modal.classList.remove('active');
        document.getElementById('delete_confirm_text').value = '';
        document.getElementById('delete_password').value = '';
    }

    async function confirmDeleteAccount() {
        const confirmText = document.getElementById('delete_confirm_text').value;
        const password = document.getElementById('delete_password').value;

        if (confirmText !== 'SUPPRIMER') {
            showNotification('Veuillez taper exactement "SUPPRIMER" pour confirmer', 'error');
            return;
        }

        if (!password) {
            showNotification('Veuillez saisir votre mot de passe', 'error');
            return;
        }

        const btn = document.querySelector('#deleteAccountModal .btn-danger:not(.btn-secondary)');
        btn.disabled = true;
        btn.textContent = 'Suppression en cours...';

        try {
            const response = await fetch('/api/user/delete-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    confirm_text: confirmText,
                    password
                })
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('Votre compte a été supprimé. Redirection...', 'success');
                setTimeout(() => window.location.href = '/login', 2000);
            } else {
                showNotification('Erreur : ' + (data.error || 'Échec de la suppression'), 'error');
                btn.disabled = false;
                btn.textContent = 'Supprimer définitivement';
            }
        } catch (error) {
            console.error('Delete error:', error);
            showNotification('Erreur réseau lors de la suppression', 'error');
            btn.disabled = false;
            btn.textContent = 'Supprimer définitivement';
        }
    }

    // Close modals on click outside
    document.getElementById('exportDataModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeExportDataModal();
        }
    });

    document.getElementById('deleteAccountModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteAccountModal();
        }
    });
</script>
{% endblock %}
